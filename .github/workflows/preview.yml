name: Preview Site

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  preview:
    # Skip this job if the PR is from renovate bot
    if: github.actor != 'cubis-renovate[bot]'

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write
      issues: write
      pull-requests: write

    concurrency:
      group: "pages-preview"
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Restore cache
        uses: actions/cache/restore@v4
        with:
          path: ryanwallace.cloud/
          key: ryanwallace-cloud-preview-${{ github.event.number }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"
          cache-dependency-path: "ryanwallace.cloud/map/yarn.lock"

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.148.2"
          extended: true

      - name: Install dependencies
        working-directory: ryanwallace.cloud/map
        run: yarn install --frozen-lockfile

      - name: Build map assets
        working-directory: ryanwallace.cloud/map
        run: yarn clean && yarn build && yarn move && yarn title

      - name: Build Hugo site
        working-directory: ryanwallace.cloud
        run: |
          hugo --cleanDestinationDir --minify --gc --baseURL https://gh.ryanwallace.cloud
        env:
          HUGO_ENVIRONMENT: preview
          HUGO_ENV: preview

      - name: Save cache
        uses: actions/cache/save@v4
        with:
          path: ryanwallace.cloud/
          key: ryanwallace-cloud-preview-${{ github.event.number }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ryanwallace.cloud/public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR number from the event payload
            const prNumber = ${{ github.event.number }};

            if (!prNumber) {
              console.log('No PR number found in event context, skipping preview comment');
              return;
            }

            const previewUrl = `https://gh.ryanwallace.cloud`;

            const comment = `
            Your changes have been deployed to a preview environment.

            **Preview URL:** [${previewUrl}](${previewUrl})

            This preview will be automatically updated when you push new commits to this PR.

            ---
            *This preview was generated by GitHub Actions*`;

            try {
              // Check if we already commented on this PR
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const existingComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('Preview URL:')
              );

              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
                console.log(`Updated existing preview comment for PR #${prNumber}`);
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
                console.log(`Created new preview comment for PR #${prNumber}`);
              }
            } catch (error) {
              console.log(`Failed to comment on PR #${prNumber}:`, error.message);
            }
