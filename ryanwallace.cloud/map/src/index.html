<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin />
<link rel="preconnect" href="https://imt.ryanwallace.cloud" crossorigin />
<link rel="preconnect" href="https://bos.ryanwallace.cloud" crossorigin />

<style>
  /* Back to Home button for map page */
  .back-to-home-btn {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1000;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: rgba(255, 255, 255, 0.95);
    color: #1f2937;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
  }

  .back-to-home-btn:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
    color: #0ea5e9;
  }

  .back-to-home-btn::before {
    content: '‚Üê';
    font-size: 1.2rem;
    font-weight: bold;
  }

  body.dark-theme .back-to-home-btn {
    background: rgba(31, 41, 55, 0.95);
    color: #f9fafb;
    border-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .back-to-home-btn:hover {
    background: rgba(31, 41, 55, 1);
    color: #38bdf8;
  }

  @media (max-width: 768px) {
    .back-to-home-btn {
      top: 0.5rem;
      left: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
  }

  /* Tracking stop icon button */
  .controls-section #tracking-stop-btn.tracking-stop-btn {
    /* hidden by JS until tracking starts; JS toggles to inline-block */
    display: none;
    -webkit-appearance: none;
    appearance: none;
    vertical-align: middle;
    width: auto;
    height: auto;
    line-height: normal;
    border-radius: 6px;
    border: 1px solid #ef4444; /* red-500 */
    color: #ef4444;
    background: rgba(239, 68, 68, 0.08);
    font-size: 13px;
    padding: 4px 10px;
    text-align: center;
    margin-left: 8px;
    cursor: pointer;
    box-shadow: none;
    outline: none;
    transition:
      background 0.15s ease,
      color 0.15s ease,
      border-color 0.15s ease,
      transform 0.1s ease;
    /* Nice alignment in case of flex display */
    align-items: center;
    justify-content: center;
  }
  .controls-section #tracking-stop-btn.tracking-stop-btn:hover {
    background: #ef4444;
    color: #fff;
    border-color: #ef4444;
  }
  .controls-section #tracking-stop-btn.tracking-stop-btn:active {
    transform: scale(0.95);
  }
  /* Map expand behavior (not full-screen) */
  #map {
    transition: height 0.2s ease;
  }
  #map.map-expanded {
    height: 80vh; /* expand but not full screen */
  }

  /* Loading overlay shouldn't block interactions */
  .map-loading-overlay {
    pointer-events: none;
  }

  /* Follow location: make active state highly visible */
  .controls-section .control-group.follow-active {
    background: rgba(34, 197, 94, 0.08); /* green-500 tint */
    border: 1px solid rgba(34, 197, 94, 0.35);
    border-radius: 8px;
    padding: 6px 8px;
  }
  .controls-section .control-group.follow-active label[for='follow-location'] {
    color: #16a34a; /* green-600 */
    font-weight: 600;
  }
  /* Boost the toggle visibility when active */
  #follow-location:checked + .slider {
    background: #22c55e !important; /* green-500 */
    box-shadow:
      0 0 0 3px rgba(34, 197, 94, 0.2),
      0 0 12px rgba(34, 197, 94, 0.5);
  }
  #follow-location:checked + .slider:before {
    background: #ffffff;
  }

  /* Tracked vehicle overlays */
  .leaflet-div-icon.tracked-info-icon {
    background: transparent;
    border: none;
    width: auto !important;
    height: auto !important;
  }
  /* Tooltip styling for tracked vehicle */
  #map .leaflet-tooltip.tracked-tooltip {
    background: rgba(255, 255, 255, 0.96);
    border: 1px solid rgba(17, 24, 39, 0.12);
    color: #111827; /* gray-900 */
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    padding: 6px 8px;
    pointer-events: none;
  }
  #map .leaflet-tooltip.tracked-tooltip .t-title {
    font-weight: 600;
    margin-bottom: 2px;
    font-size: 12px;
  }
  #map .leaflet-tooltip.tracked-tooltip .t-meta {
    font-size: 11px;
    color: #374151; /* gray-700 */
  }

  /* Legacy divIcon label (kept for safety) */
  .tracked-label {
    font-family:
      system-ui,
      -apple-system,
      Segoe UI,
      Roboto,
      Helvetica,
      Arial,
      sans-serif;
    font-size: 12px;
    line-height: 1.25;
    background: rgba(255, 255, 255, 0.96);
    color: #111827; /* gray-900 */
    border: 1px solid rgba(17, 24, 39, 0.12);
    border-radius: 6px;
    padding: 6px 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    transform: translate(-50%, -120%);
    pointer-events: none;
    white-space: nowrap;
  }
  .tracked-label .t-title {
    font-weight: 600;
    margin-bottom: 2px;
  }
  .tracked-label .t-meta {
    font-size: 11px;
    color: #374151; /* gray-700 */
  }
  .tracked-pulse {
    width: 60px;
    height: 60px;
    /* rely on Leaflet iconAnchor for centering to avoid double-shift jitter */
    pointer-events: none;
    background: transparent;
    border: none;
  }
  .tracked-pulse span {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 9999px;
    border: 2px solid
      rgba(var(--pulse-r, 239), var(--pulse-g, 68), var(--pulse-b, 68), 0.9);
    box-shadow: 0 0 0 0
      rgba(var(--pulse-r, 239), var(--pulse-g, 68), var(--pulse-b, 68), 0.7);
    animation: tracked-pulse 1.8s ease-out infinite;
  }
  @keyframes tracked-pulse {
    0% {
      box-shadow: 0 0 0 0
        rgba(var(--pulse-r, 239), var(--pulse-g, 68), var(--pulse-b, 68), 0.6);
      opacity: 1;
    }
    70% {
      box-shadow: 0 0 0 16px
        rgba(var(--pulse-r, 239), var(--pulse-g, 68), var(--pulse-b, 68), 0);
      opacity: 0.6;
    }
    100% {
      box-shadow: 0 0 0 0
        rgba(var(--pulse-r, 239), var(--pulse-g, 68), var(--pulse-b, 68), 0);
      opacity: 0.4;
    }
  }
</style>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css"
/>

<div id="map" class="noselect"></div>
<div class="controls-section">
  <div class="control-group">
    <a href="/" class="back-to-home-btn">Home</a>
    <label for="refresh-rate">Refresh rate:</label>
    <select name="refresh-rate" id="refresh-rate">
      <option value="5">5 seconds</option>
      <option value="10">10 seconds</option>
      <option value="15" selected>15 seconds</option>
      <option value="30">30 seconds</option>
      <option value="60">60 seconds</option>
      <option value="99999">Off</option>
    </select>
  </div>

  <div class="control-group">
    <label>Live updates:</label>
    <span id="sse-status" class="live-badge live-polling">Polling</span>
  </div>

  <div class="control-group">
    <label>Tracking:</label>
    <span id="tracking-status" class="live-badge">Off</span>
    <button
      id="tracking-stop-btn"
      class="tracking-stop-btn"
      aria-label="Stop tracking"
      title="Stop tracking"
    >
      Stop
    </button>
  </div>

  <div class="control-group">
    <label for="follow-location">Follow location:</label>
    <label class="toggle-switch">
      <input type="checkbox" id="follow-location" name="follow-location" />
      <span class="slider"></span>
    </label>
  </div>

  <div class="control-group">
    <span
      id="mode-conflict"
      class="mode-note"
      style="display: none; color: #6b7280; font-size: 12px"
    ></span>
  </div>
</div>

<script type="module" src="./map.ts"></script>

<h4>Currently Operating Vehicles</h4>
<table id="vehicle-table">
  <tr>
    <td><i>Vehicle Type</i></td>
    <td class="rl"><b>RL</b></td>
    <td class="gl"><b>GL</b></td>
    <td class="bl"><b>BL</b></td>
    <td class="ol"><b>OL</b></td>
    <td class="sl"><b>SL</b></td>
    <td class="cr"><b>CR</b></td>
    <td><i>Totals</i></td>
  </tr>
  <tr>
    <td><small>Light Rail</small></td>
    <td id="rl-light" class="rl">0</td>
    <td id="gl-light" class="gl">0</td>
    <td id="bl-light">0</td>
    <td id="ol-light">0</td>
    <td id="sl-light">0</td>
    <td id="cr-light">0</td>
    <td id="light-total">0</td>
  </tr>
  <tr>
    <td><small>Heavy Rail</small></td>
    <td id="rl-heavy" class="rl">0</td>
    <td id="gl-heavy">0</td>
    <td id="bl-heavy" class="bl">0</td>
    <td id="ol-heavy" class="ol">0</td>
    <td id="sl-heavy">0</td>
    <td id="cr-heavy">0</td>
    <td id="heavy-total">0</td>
  </tr>
  <tr>
    <td><small>Regional Rail</small></td>
    <td id="rl-regional">0</td>
    <td id="gl-regional">0</td>
    <td id="bl-regional">0</td>
    <td id="ol-regional">0</td>
    <td id="sl-regional">0</td>
    <td id="cr-regional" class="cr">0</td>
    <td id="regional-total">0</td>
  </tr>
  <tr>
    <td><small>Bus</small></td>
    <td id="rl-bus">0</td>
    <td id="gl-bus">0</td>
    <td id="bl-bus">0</td>
    <td id="ol-bus">0</td>
    <td id="sl-bus" class="sl">0</td>
    <td id="cr-bus">0</td>
    <td id="bus-total">0</td>
  </tr>
  <tr>
    <td><i>Totals</i></td>
    <td id="rl-total" class="rl">0</td>
    <td id="gl-total" class="gl">0</td>
    <td id="bl-total" class="bl">0</td>
    <td id="ol-total" class="ol">0</td>
    <td id="sl-total" class="sl">0</td>
    <td id="cr-total" class="cr">0</td>
    <td id="total"><b>0</b></td>
  </tr>
</table>

<div class="info-links">
  <p>
    <a href="http://roster.transithistory.org/" target="_blank"
      >Full MBTA Vehicle Inventory</a
    >
  </p>

  <p>
    This map live updates using the
    <a href="/posts/inky-mbta-tracker-guide/" target="_blank"
      >Inky MBTA Tracker</a
    >
    <br />
    Data comes from the
    <a href="https://www.mbta.com/developers/v3-api" target="_blank"
      >MBTA V3 API</a
    >
    <br />
    Icons from
    <a href="https://labs.mapbox.com/maki-icons/" target="_blank"
      >Mapbox Maki Icons</a
    >
  </p>

  <div class="control-group" style="margin-top: 20px">
    <label for="show-elf-mode">üßù‚Äç‚ôÄÔ∏è Show Elf Scores:</label>
    <label class="toggle-switch">
      <input type="checkbox" id="show-elf-mode" name="show-elf-mode" />
      <span class="slider"></span>
    </label>
    <small style="display: block; margin-top: 5px; color: #666">
      Find queer, trans, and non-binary elves on transit! üè≥Ô∏è‚Äç‚ößÔ∏è‚ú®
    </small>
  </div>

  <div class="control-group" style="margin-top: 15px">
    <button id="elf-search-btn" class="elf-search-button">
      üîç Find Best Elf Trains
    </button>
    <div
      id="elf-search-results"
      class="elf-search-results"
      style="display: none"
    >
      <div class="elf-results-header">
        <span>üßù‚Äç‚ôÄÔ∏è Top Elf Trains</span>
        <button id="elf-search-close" class="elf-search-close">√ó</button>
      </div>
      <div id="elf-results-list" class="elf-results-list"></div>
    </div>
  </div>
</div>

<div class="info-links" style="margin-top: 16px">
  <p>
    <a href="/alerts">View MBTA Service Alerts ‚Üí</a>
  </p>
</div>
